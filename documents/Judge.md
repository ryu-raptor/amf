# 判定

x-----
-x----

x-----
x-----

x===x-
---x--

## 前提
- ノーツを置ける枠をトレースという.
- トレースにはUp/Downの枠がある.
- 枠にはTap, Pressのどれかが入る.
- トレースは時刻の早い方から順に処理される.
- 入力は現在時刻に最も近いトレースに渡される.
- 渡されたトレースより早いトレースは全て処理済みにされる. この時判定は全てBadである.
- 判定にはNiceとBadの2種類がある.

## 実装
- トレースにノーツを保持させるのはトレースの負荷が大きい.
- upperNotesとlowerNotesの2つのリストにノーツを登録しておく. ノーツは対応するトレースを記録してある.
- ノーツは現在時刻から自分が選ばれる指標(メトリック)を計算できる. これをもとに処理するノーツを決定する.
- メトリックは小さいほど選ばれやすい. 一番選ばれやすいノーツを軸にV字にグラフを描ける. 負の無限大から走査した時, 最小値を踏んだ後はそれより大きな値が出ない. そういう関数を選ぶ.
- 処理されるノーツより時間的に早いノーツで, 処理済みでないものは全てBadとして処理し, 詰める. こうして一番最初の要素が一番最初に処理されるようにする.
- ノーツは時刻情報とボタン押下情報を与えられ, 処理を行う.
- ノーツはスコアが入った時にputScoreフックを呼び出す.
- ノーツの処理の戻り値によりノーツの処遇を決める. {Keep, Release} : Keepはリストに保持しておく, Releaseはファイナライズベクターに転送する.
- ファイナライズベクターはノーツが処理を終わらせた後のエフェクトなどを行わせるためにある. Finalizableを継承しており, finalizeメソッドがtrueを返した時に完全にdeleteされる.

## メトリック

### Tap

V
-----X-----

metric = abs(V-X)

### Press

V
-----X------Y-----Z----

metric = abs(V-X)



       V
-----X------Y-----Z----

metric = 0 


                     V 
-----X------Y-----Z----

metric = abs(V-Z)

## state

### Tap

### Press

